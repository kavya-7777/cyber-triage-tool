<!-- templates/report.html -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Case Report — {{ case_id }}</title>

  <style>
    body { font-family: "Helvetica", Arial, sans-serif; color: #111; margin: 24px; background: #fff; }
    header { border-bottom: 2px solid #ddd; padding-bottom: 8px; margin-bottom: 16px; }
    h1 { font-size: 20px; margin: 0 0 4px 0; }
    .meta { color: #555; font-size: 12px; margin-bottom: 12px; }
    section { margin-bottom: 16px; }
    table { border-collapse: collapse; width: 100%; font-size: 12px; }
    th, td { border: 1px solid #ddd; padding: 6px 8px; text-align: left; vertical-align: top; }
    th { background: #f7fafc; font-weight: 700; }
    .small { font-size: 11px; color: #444; }
    .muted { color: #666; font-size: 11px; }
    .page-break { page-break-after: always; }
    .score { font-weight:700; color:#b03; }
    .raw-meta { font-family: monospace; font-size: 10px; white-space: pre-wrap; background:#fafafa; padding:6px; border-radius:4px; border:1px solid #eee; }
  </style>
</head>
<body>
  <header style="border-bottom:2px solid #ddd; padding-bottom:8px; margin-bottom:16px;">
  <div style="display:flex; align-items:center; gap:8px; margin-bottom:4px;">
    <h1 style="margin:0; font-size:20px;">Case Report — {{ case_id }}</h1>
    <a href="{{ url_for('report_pdf', case_id=case_id) }}"
       title="Download PDF Report"
       style="color:black; text-decoration:none;">
      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18"
           fill="none" stroke="black" stroke-width="2"
           stroke-linecap="round" stroke-linejoin="round"
           viewBox="0 0 24 24">
        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
        <polyline points="7 10 12 15 17 10" />
        <line x1="12" y1="15" x2="12" y2="3" />
      </svg>
    </a>
  </div>

  <div class="meta" style="font-size:12px; color:#555;">
    Generated: {{ generated_at | ist_time if generated_at is defined else "-" }} ·
  </div>
</header>

  <section>
    <h2>Artifacts</h2>
    {% if artifacts and artifacts|length %}
      <table>
        <thead>
          <tr>
            <th style="width:22%;">File Details</th>
            <th style="width:10%;">Size</th>
            <th style="width:14%;">Uploaded</th>
            <th style="width:10%;">Score</th>
            <th>Key analysis</th>
          </tr>
        </thead>
        <tbody>
          {% for a in artifacts %}
          {% set artifact_id = (a.get('artifact_id') if a is mapping else (a.artifact_id if a is defined and a.artifact_id is defined else None)) or (a.get('id') if a is mapping else None) or 'unknown' %}
          {% set filename = (a.get('original_filename') if a is mapping else (a.original_filename if a is defined and a.original_filename is defined else None)) or (a.get('saved_filename') if a is mapping else (a.saved_filename if a is defined and a.saved_filename is defined else None)) or 'unknown' %}
          {% set size_bytes = (a.get('size_bytes') if a is mapping else (a.size_bytes if a is defined and a.size_bytes is defined else None)) %}
          {% set uploaded_at = (a.get('uploaded_at') if a is mapping else (a.uploaded_at if a is defined and a.uploaded_at is defined else None)) %}
          {% set uploaded_by = (a.get('uploaded_by') if a is mapping else (a.uploaded_by if a is defined and a.uploaded_by is defined else None)) %}
          {% set analysis = (a.get('analysis') if a is mapping else (a.analysis if a is defined and a.analysis is defined else None)) %}
          {% if analysis is none %}{% set analysis = {} %}{% endif %}
          {% set final_score = (analysis.get('final_score') if analysis is mapping else (a.get('final_score') if a is mapping else (a.final_score if a is defined and a.final_score is defined else None))) %}
          <tr>
            <td style="word-break: break-all; white-space: normal;">
  <div>{{ filename }}</div>
  <div class="muted"><code style="word-break: break-all; white-space: normal;">{{ artifact_id }}</code></div>
</td>

            <td class="small">
              {% if size_bytes %}{{ size_bytes }} bytes{% else %}-{% endif %}
            </td>
            <td class="small">
             {% if uploaded_at %} {{ uploaded_at | ist_time }} {% else %} - {% endif %}<br/>
              <span class="muted">{% if uploaded_by %}{{ uploaded_by }}{% else %}-{% endif %}</span>
            </td>
            <td class="small">
              {% if final_score is not none %}
                <span class="score">
                  {% if final_score is string %}
                    {{ final_score }}{% if '%' not in final_score %}%{% endif %}
                  {% else %}
                    {{ final_score }}%
                  {% endif %}
                </span>
              {% else %}
                -
              {% endif %}
            </td>
            <td class="small">
              {% if analysis is mapping %}
                {% if analysis.final_reasons %}
                  <ul>
                    {% for r in analysis.final_reasons %}
                      <li>{{ r }}</li>
                    {% endfor %}
                  </ul>
                {% elif analysis.reasons %}
                  <div>{{ analysis.reasons | join(', ') }}</div>
                {% else %}
                  <div class="muted">analysis available — keys: {{ analysis.keys() | list | join(', ') }}</div>
                {% endif %}
              {% elif analysis %}
                <div class="muted">analysis present (non-mapping)</div>
              {% else %}
                <div class="muted">no analysis metadata</div>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    {% else %}
      <div class="muted">No artifact metadata found for this case.</div>
    {% endif %}
  </section>

  <div class="page-break"></div>

  <section>
    <h2>Included files</h2>
    <div class="small">
      Artifacts: {{ artifacts|length }}<br/>
      </div>
    <ul class="small">
      {% for a in artifacts %}<li>artifact metadata: {{ a.original_filename if a.original_filename is defined else (a.artifact_id if a.artifact_id is defined else 'unknown') }}</li>{% endfor %}
    </ul>
  </section>

  <footer class="small muted">
    PDF generated by the case system.
  </footer>
</body>
</html>